#!/bin/sh

MODULELIST=$(semodule -l | awk '{print $1}');

cd /usr/portage/sec-policy;
for PACKAGE in *;
do
  [ ! -d ${PACKAGE} ] && continue;
  [ ! -f ${PACKAGE}/metadata.xml ] && continue;
  [ "${PACKAGE}" = "selinux-base" ] && continue;
  [ "${PACKAGE}" = "selinux-base-policy" ] && continue;
  ## Install it
  echo "Installing ${PACKAGE}... ";
  emerge ${PACKAGE} > ${PACKAGE}.log 2>&1;
  MODULE=${PACKAGE##selinux-};
  ## Clean it
  echo ${MODULELIST} | grep -q ${MODULE};
  if [ $? -ne 0 ];
  then
    emerge -C ${PACKAGE} > /dev/null 2>&1;
    emerge --depclean > /dev/null 2>&1;
    CLEAN=0;
    while [ ${CLEAN} -eq 0 ];
    do
      CLEAN=1;
      CURRENTMODULELIST=$(semodule -l | awk '{print $1}');
      for MOD in ${CURRENTMODULELIST};
      do
        echo ${MODULELIST} | grep -q ${MOD};
	if [ $? -ne 0 ];
	then
	  echo " - Removing ${MOD} from runtime";
	  for STORE in /etc/selinux/*;
	  do
            test -d ${STORE} || continue;
	    semodule -s $(basename ${STORE}) -r ${MOD};
	  done
	  CLEAN=0;
	fi
      done
    done
  fi
done
